# Cloud Builder pipeline
# https://cloud.google.com/container-builder/docs/overview

steps:
# Build the openjdk image
- name: 'gcr.io/cloud-builders/java/mvn:3.3.9-jdk-8'
  args:
  - 'clean'
  - 'install'
  - '--batch-mode'
  - '-Ddocker.image.name=${_IMAGE}'
  # only build the specified module
  - '--projects=${_MODULE}'
  - '--also-make'
  id: 'MVN_PACKAGE'

# Tag and push the openjdk image to a staging repository for integration testing
- name: 'gcr.io/cloud-builders/docker'
  args: ['tag', '${_IMAGE}', '${_STAGING_IMAGE}']
  id: 'TAG_STAGING_IMG'
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', '${_STAGING_IMAGE}']
  id: 'PUSH_STAGING_IMG'

# Execute integration tests
- name: 'gcr.io/java-runtime-test/mvn-gcloud-builder'
  entrypoint: 'scripts/integration_test.sh'
  args: ['${_STAGING_IMAGE}']
  id: 'INTEGRATION_TEST'

images: ['${_IMAGE}']
